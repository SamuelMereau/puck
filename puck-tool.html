<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        label {
            display: block;
        }

        #img-container {
            width: max-content;
            height: max-content;
            display: flex;
            overflow: hidden;
            margin: 20px 0;
        }

        #img-to-modify {
            flex: 1;
        }

        #generated-img-container {
            width: max-content;
            height: max-content;
        }
    </style>
    <title>Puck Tester</title>
    <script src="./dom-to-image.js" type="text/javascript"></script>
</head>
<body>
    <div id="controls">
        <label id="borderRadius-lbl">borderRadius</label>
        <input id="borderRadius" type="range" min="0" max="50" value="50"/>

        <h2>Padding</h2>
        <label id="paddingTop-lbl">paddingTop</label>
        <input id="paddingTop" class="paddingCtrl" type="range" min="0" max="500" value="0">

        <label id="paddingRight-lbl">paddingRight</label>
        <input id="paddingRight" class="paddingCtrl" type="range" min="0" max="500" value="0">
        
        <label id="paddingBottom-lbl">paddingBottom</label>
        <input id="paddingBottom" class="paddingCtrl" type="range" min="0" max="500" value="0">

        <label id="paddingLeft-lbl">paddingLeft</label>
        <input id="paddingLeft" class="paddingCtrl" type="range" min="0" max="500" value="0"><br/>

        <h2>Margin</h2>
        <label id="marginTop-lbl">marginTop</label>
        <input id="marginTop" class="marginCtrl" type="range" min="-500" max="500" value="0">

        <label id="marginRight-lbl">marginRight</label>
        <input id="marginRight" class="marginCtrl" type="range" min="-500" max="500" value="0">

        <label id="marginBottom-lbl">marginBottom</label>
        <input id="marginBottom" class="marginCtrl" type="range" min="-500" max="500" value="0">

        <label id="marginLeft-lbl">marginLeft</label>
        <input id="marginLeft" class="marginCtrl" type="range" min="-500" max="500" value="0"><br/><br/>

        <button id="puckify" onclick="puckifyImage()">Puck-ify image</button>
        <button id="inverse-puckify" onclick="inversePuckifyImage()">Inverse Puck-ify Image</button>
        <button id="align-image" onclick="alignImage()">Align Image</button>
        <button id="convert-image" onclick="convertImage()">Convert Out To SVG</button>
    </div>
    <h2 style="margin-top: 50px;">Simulated Result</h2>
    <div id="img-container">
        <img id="img-to-modify" src="/logo.png" width="250" height="250" alt="Logo">
    </div>
    <h2 style="margin-top: 50px;">Generated Result</h2>
    <div id="generated-img-container"></div>
    
    <script>
        const controls = document.querySelector('#controls').getElementsByTagName('input');
        const sliderLabels = document.querySelector('#controls').getElementsByTagName('label');
        const img = document.querySelector('#img-to-modify');

        /** Returns which unit should be used with certain CSS properties */
        function getUnit(elementId) {
            return elementId == "borderRadius" ? "%" : "px";
        }

        /** Gets the currently set padding values and returns them as an object*/
        function getPadding() {
            const img = document.querySelector('#img-to-modify');
            const imgStyle = window.getComputedStyle(img);
            return { 
                paddingTop: parseInt(imgStyle.paddingTop), 
                paddingRight: parseInt(imgStyle.paddingRight),
                paddingBottom: parseInt(imgStyle.paddingBottom),
                paddingLeft: parseInt(imgStyle.paddingLeft)
            }
        }

        // padding: 10% 40% 40% 10%;
        function puckifyImage() {
            document.querySelector('#borderRadius').value = 50;
            const paddingCtrls = document.getElementsByClassName('paddingCtrl');
            [...paddingCtrls].forEach((elem) => {
                switch (elem.id) {
                    case "paddingTop":
                        elem.value = (img.height / 100) * 10;
                        break;
                    case "paddingRight":
                        elem.value = (img.height / 100) * 40;
                        break;
                    case "paddingBottom":
                        elem.value = (img.height / 100) * 40;
                        break;
                    case "paddingLeft":
                        elem.value = (img.height / 100) * 10;
                        break;
                }
            });
            sync();
            alignImage();
        }

        // padding: 30% 10% 10% 30%
        function inversePuckifyImage() {
            document.querySelector('#borderRadius').value = 50;
            const paddingCtrls = document.getElementsByClassName('paddingCtrl');
            [...paddingCtrls].forEach((elem) => {
                switch (elem.id) {
                    case "paddingTop":
                        elem.value = (img.height / 100) * 30;
                        break;
                    case "paddingRight":
                        elem.value = (img.height / 100) * 10;
                        break;
                    case "paddingBottom":
                        elem.value = (img.height / 100) * 10;
                        break;
                    case "paddingLeft":
                        elem.value = (img.height / 100) * 30;
                        break;
                }
            });
            sync();
            alignImage();
        }

        /** Sets all margins to 0 */
        function resetAlignment() {
            const marginCtrls = document.getElementsByClassName('marginCtrl');
            [...marginCtrls].forEach((elem) => { elem.value = 0; });
        }

        /** Uses margin to align the image to the top left corner */
        function alignImage() {
            resetAlignment();
            const marginCtrls = document.getElementsByClassName('marginCtrl');
            [...marginCtrls].forEach((elem) => {
                switch (elem.id) {
                    case "marginTop":
                        elem.value = -getPadding().paddingTop;
                        break;
                    case "marginRight":
                        elem.value = -getPadding().paddingRight;
                        break;
                    case "marginBottom":
                        elem.value = -getPadding().paddingBottom;
                        break;
                    case "marginLeft":
                        elem.value = -getPadding().paddingLeft;
                        break;
                }
            });
            sync();
        }

        /** Uses the dom-to-image library to convert an HTML element to an SVG */
        function convertImage() {
            alignImage();
            const container = document.querySelector('#generated-img-container');
            domtoimage.toSvg(document.querySelector('#img-to-modify'))
                .then(function (svg) {
                    if (container.hasChildNodes()) {
                        container.querySelectorAll('*').forEach(node => node.remove());
                    }
                    const svgNode = document.createElement('svg');
                    svgNode.innerHTML = svg;
                    svgNode.crossOrigin = 'Anonymous';
                    container.appendChild(svgNode.childNodes[1]);
                    const generatedSvg = document.querySelector('#generated-img-container svg');
                    generatedSvg.childNodes[0].childNodes[0].removeAttribute('id');
                    generatedSvg.setAttribute("width", img.clientWidth - (parseInt(getPadding().paddingLeft) + parseInt(getPadding().paddingRight)));
                    generatedSvg.setAttribute("height", img.clientHeight - (parseInt(getPadding().paddingTop) + parseInt(getPadding().paddingBottom)));
                });
        }

        /** Sync control values with image styling; Border radius is not 0 by default */
        function sync() {
            [...controls].forEach((elem) => { img.style[elem.id] = elem.value + getUnit(elem.id) });
            [...sliderLabels].forEach((elem) => { elem.textContent = `${elem.id.split('-lbl')[0]}: ${elem.nextElementSibling.value}${getUnit(elem.id.split('-lbl')[0])}` });
        }

        [...controls].forEach((elem) => elem.addEventListener('input', function (e) {
            img.style[e.target.id] = e.target.value + getUnit(e.target.id);
            // Update Label
            const label = document.querySelector(`#${e.target.id}-lbl`);
            label.textContent = `${e.target.id}: ${e.target.value}${getUnit(e.target.id)}`;
        }));

        sync();
    </script>
</body>
</html>